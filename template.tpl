___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Refiner",
  "categories": ["SURVEY", "PERSONALIZATION", "SALES"],  
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "Close the customer feedback loop with highly configurable in-app survey widgets for SaaS.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "Project UUID",
    "displayName": "Refiner Project ID",
    "simpleValueType": true,
    "help": "Locate the project ID in your Refiner account in the settings sections.",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "STRING_LENGTH",
        "args": [
          32,
          40
        ]
      }
    ],
    "valueHint": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxx",
    "alwaysInSummary": true
  },
  {
    "type": "TEXT",
    "name": "User ID",
    "displayName": "User ID (recommended)",
    "simpleValueType": true,
    "help": "Unleash the full power of Refiner by providing a unique identifier for each user. Use the Google Tag Manager Data Layer to provide the user ID. Providing a user ID is optional but recommended.",
    "valueHint": "e.g. {{User ID}}"
  },
  {
    "type": "TEXT",
    "name": "User Email",
    "displayName": "User Email (optional)",
    "simpleValueType": true,
    "valueHint": "e.g. user@company.com"
  },
  {
    "type": "TEXT",
    "name": "User Name",
    "displayName": "User Name (optional)",
    "simpleValueType": true,
    "valueHint": "e.g. Jane Doe"
  },
  {
    "type": "PARAM_TABLE",
    "name": "Additional Data",
    "displayName": "More User Traits (optional)",
    "paramTableColumns": [
      {
        "param": {
          "type": "TEXT",
          "name": "slug",
          "displayName": "Field Identifier",
          "simpleValueType": true,
          "valueHint": "e.g. some_other_data",
          "valueValidators": [
            {
              "type": "NON_EMPTY"
            },
            {
              "type": "NON_EMPTY"
            }
          ]
        },
        "isUnique": true
      },
      {
        "param": {
          "type": "TEXT",
          "name": "value",
          "displayName": "Field Value",
          "simpleValueType": true,
          "valueHint": "e.g. {{ Another Data Field }}",
          "valueValidators": [
            {
              "type": "NON_EMPTY"
            }
          ]
        },
        "isUnique": false
      }
    ]
  },
  {
    "type": "PARAM_TABLE",
    "name": "Additional Response Data",
    "displayName": "Add Data to Survey Responses (optional)",
    "paramTableColumns": [
      {
        "param": {
          "type": "TEXT",
          "name": "slug",
          "displayName": "Field Identifier",
          "simpleValueType": true
        },
        "isUnique": true
      },
      {
        "param": {
          "type": "TEXT",
          "name": "value",
          "displayName": "Field Value",
          "simpleValueType": true
        },
        "isUnique": false
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const injectScript = require('injectScript');
const url = 'https://js.refiner.io/v001/client.js';
const createArgumentsQueue = require('createArgumentsQueue');
const _refiner = createArgumentsQueue('_refiner', '_refinerQueue');

//const log = require('logToConsole');
//log(data);

_refiner('setInstallationMethod', 'gtm');

_refiner('setProject', data['Project UUID']);  

if (data['Additional Response Data']) {
  var additionalResponseData = {};
  for(var i = 0; i < data['Additional Response Data'].length; i++) { 
    var row = data['Additional Response Data'][i];
    additionalResponseData[row.slug] = row.value;
  }  
  _refiner('addToResponse', additionalResponseData);
}

if (data['User ID'] || data['User Email'] || data['User Name']) {
  
    var userData = {
      id: data['User ID'] || null,
      email: data['User Email'] || null, 
      name: data['User Name'] || null, 
      account: {}
    };

    if (data['Additional Data']) {
      for(var i = 0; i < data['Additional Data'].length; i++) { 
        var row = data['Additional Data'][i];
        if(row.slug.indexOf("account.") > -1 ) {
          let slug = row.slug.replace("account.","");
          userData.account[slug] = row.value;
        } else {
          userData[row.slug] = row.value;
        }
      }  
    }  
    
    _refiner('identifyUser', userData);
  
} else {
  _refiner('ping');
}

injectScript(url, data.gtmOnSuccess(), data.gtmOnFailure(), url);


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://js.refiner.io/v001/client.js"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_refinerQueue"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_refiner"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_refinerTracker"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Check Identify
  code: |-
    const mockData = {
      'Project ID': '56421950-5d32-11ea-9bb4-9f1f1a987a49',
      'User ID': 'user-id-test',
      'User Email': 'test@refiner.io',
      'User Name': 'Google Tag Manager',
      'Additional Data': [],
      'Additional Response Data': []
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();


___NOTES___

Created on 24/03/2020, 10:28:50

